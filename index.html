<script>
(function () {
  'use strict';

  // ===== Google Sheets =====
  var FILE_ID = "1-2oS--u1jf0fm-m9N_UDf5-aN-oLg_-wyqEpMSdcvcU";
  var GVIZ = 'https://docs.google.com/spreadsheets/d/' + FILE_ID + '/gviz/tq?tqx=out:json&headers=1&sheet=';

  // シート名マッピング（列Aに slug 一覧）
  var SHEETS = {
    charge: { s1: "チャージAL①", s2: "チャージAL②" },
    nft:    { s1: "NFTコラボAL①", s2: "NFTコラボAL②" },
    guild:  { s1: "ギルドミッションAL①", s2: "ギルドミッションAL②" },
    greet:  { s1: "挨拶タップAL①", s2: "挨拶タップAL②" }
  };

  // ===== UI 参照（ここ以外のDOM=ブレ撮りには触れない）=====
  var UI = {
    input:  document.getElementById('slugInput')  || document.querySelector('input[name="slug"]'),
    btn:    document.getElementById('searchBtn')  || document.querySelector('button[data-role="search"]'),
    status: document.getElementById('statusSlug') || document.querySelector('[data-role="statusSlug"]'),
    err:    document.getElementById('alError')    || document.querySelector('[data-role="alError"]'),
    pills: {
      charge1: document.getElementById('pill-charge-1') || document.querySelector('[data-pill="charge-1"]'),
      charge2: document.getElementById('pill-charge-2') || document.querySelector('[data-pill="charge-2"]'),
      nft1:    document.getElementById('pill-nft-1')    || document.querySelector('[data-pill="nft-1"]'),
      nft2:    document.getElementById('pill-nft-2')    || document.querySelector('[data-pill="nft-2"]'),
      guild1:  document.getElementById('pill-guild-1')  || document.querySelector('[data-pill="guild-1"]'),
      guild2:  document.getElementById('pill-guild-2')  || document.querySelector('[data-pill="guild-2"]'),
      greet1:  document.getElementById('pill-greet-1')  || document.querySelector('[data-pill="greet-1"]'),
      greet2:  document.getElementById('pill-greet-2')  || document.querySelector('[data-pill="greet-2"]')
    }
  };

  document.addEventListener('DOMContentLoaded', function () {
    try {
      boot();
    } catch (e) {
      fatal(e);
    }
  });

  function boot() {
    // 初期は全ピルをオフ表示（表は最初から出したまま）
    setAll(false);

    if (UI.btn) UI.btn.addEventListener('click', run);
    if (UI.input) {
      UI.input.addEventListener('keydown', function (e) {
        if (e.key === 'Enter') run();
      });
    }
  }

  function normalize(s) {
    if (!s) return '';
    s = String(s).trim();
    s = s.replace(/\u3000/g, '');       // 全角空白除去
    s = s.replace(/\s+/g, '');          // 途中の空白除去
    s = s.replace(/_/g, '-');           // _ を - に統一
    return s.toLowerCase();
  }

  function parseGViz(text) {
    // google.visualization.Query.setResponse({...});
    var json = text.replace(/^[^{]+/, '').replace(/;?\s*$/, '');
    return JSON.parse(json);
  }

  function fetchSheetSet(sheetName) {
    var url = GVIZ + encodeURIComponent(sheetName) + '&tq=' + encodeURIComponent('select A');
    return fetch(url, { cache: 'no-store' })
      .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.text(); })
      .then(function (txt) {
        var obj = parseGViz(txt);
        var rows = obj.table && obj.table.rows ? obj.table.rows : [];
        var set = Object.create(null);
        for (var i = 0; i < rows.length; i++) {
          var v = rows[i].c && rows[i].c[0] ? rows[i].c[0].v : null;
          var n = normalize(v);
          if (n) set[n] = true;
        }
        return set; // {slug: true, ...}
      });
  }

  function setPill(el, on) {
    if (!el) return;
    el.classList.remove('is-on', 'is-off');
    el.classList.add(on ? 'is-on' : 'is-off');
    var base = el.getAttribute('data-label') || el.textContent.replace(/\s+/g,'');
    el.textContent = base + (on ? ' ✓' : ' －');
    el.setAttribute('aria-pressed', on ? 'true' : 'false');
  }

  function setAll(on) {
    setPill(UI.pills.charge1, on);
    setPill(UI.pills.charge2, on);
    setPill(UI.pills.nft1,    on);
    setPill(UI.pills.nft2,    on);
    setPill(UI.pills.guild1,  on);
    setPill(UI.pills.guild2,  on);
    setPill(UI.pills.greet1,  on);
    setPill(UI.pills.greet2,  on);
    if (UI.err) { UI.err.textContent = ''; UI.err.classList.remove('show'); }
  }

  function showError(msg) {
    if (UI.err) { UI.err.textContent = msg; UI.err.classList.add('show'); }
  }

  function run() {
    setAll(false); // 毎回リセット
    var raw = UI.input && UI.input.value ? UI.input.value : '';
    var slug = normalize(raw);
    if (UI.status) UI.status.textContent = slug || '—';
    if (!slug) return;

    Promise.all([
      fetchSheetSet(SHEETS.charge.s1), fetchSheetSet(SHEETS.charge.s2),
      fetchSheetSet(SHEETS.nft.s1),    fetchSheetSet(SHEETS.nft.s2),
      fetchSheetSet(SHEETS.guild.s1),  fetchSheetSet(SHEETS.guild.s2),
      fetchSheetSet(SHEETS.greet.s1),  fetchSheetSet(SHEETS.greet.s2)
    ]).then(function (a) {
      setPill(UI.pills.charge1, !!a[0][slug]);
      setPill(UI.pills.charge2, !!a[1][slug]);
      setPill(UI.pills.nft1,    !!a[2][slug]);
      setPill(UI.pills.nft2,    !!a[3][slug]);
      setPill(UI.pills.guild1,  !!a[4][slug]);
      setPill(UI.pills.guild2,  !!a[5][slug]);
      setPill(UI.pills.greet1,  !!a[6][slug]);
      setPill(UI.pills.greet2,  !!a[7][slug]);
    }).catch(function (e) {
      console.error(e);
      showError('取得エラー。時間をおいて再実行してください。');
    });
  }

  function fatal(e){
    console.error(e);
    showError('初期化エラー');
  }
})();
</script>
